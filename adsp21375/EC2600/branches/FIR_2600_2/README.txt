2015-04-23
	相位校正器

2015-04-29
	version 0.2
	使用说明

	信号通道：

          INPUT0 --+--> Phase_system0 ---> OUTPUT_A
                   |
                   +--> Delay0(TAPS/2) --> OUTPUT_C
	    		   |
                   +---------------------> OUTPUT_E

          INPUT1 --+--> Phase_system1 ---> OUTPUT_B
                   |
                   +--> Delay1(TAPS/2) --> OUTPUT_D
	    		   |
                   +---------------------> OUTPUT_F
	
		FIR 相位系统 Phase_system0 和 Phase_system1 401 阶。
		Delay0 和 Delay1 也是 401 阶FIR，200 点延迟，作为测试参考。

		上电后从 FLASH 读取2通道有效相位数据，0分区数据作为 Phase_system0，
		1分区数据作为 Phase_system1 的参数。如FLASH数据无效，则使用程序默认
		参数。程序默认参数定义在 initialphase.h 文件。

	串口控制命令：
		串口设置：19200bps，8bit，N-parity, 1 stop bit

        (01hello             8字节,用于测试
        (01bye               6字节,用于测试

        (01PCCDAT0DAT1DAT2......     6+278×4 字节
        功能：上传相位数据。CC为通道号，00--0通道，01--1通道。
        DAT1、DAT2、DAT3...用于设置相位数据，每个数据是 1/24 倍频程的相位
		位值，乘以10000，取整，转换成四位 16 进制 ASCII 码。
		DAT1对应的频率是10Hz，DAT2对应的频率是 10.293Hz(10*2^(1/24))，
		到30000Hz共 278 个值(10*2^(278/24)=30685Hz),见下表：
	
              Frequency|   Phase(rad)  | Hex
	         ----------+---------------+------- 
                 10.00 | -0.0085654444 | FFAB
                 10.29 | -0.0088164135 | FFA9
                 10.59 | -0.0090747261 | FFA6
                 10.91 | -0.0093406140 | FFA4
                 11.22 | -0.0096142878 | FFA1
                 11.55 | -0.0098959831 | FF9E
                 11.89 | -0.0101859271 | FF9B
                .....  |    .......    | ....
              23661.39 |  1.9280563592 | 4B51
              24354.72 |  1.9011012315 | 4A43
              25068.37 |  1.8525086641 | 485D
              25802.93 |  1.7787340879 | 457B
              26559.01 |  1.6757329702 | 4175
              27337.25 |  1.5390986204 | 3C1F
              28138.29 |  1.3644338846 | 354C
              28962.80 |  1.1480319499 | 2CD8
              29811.48 |  0.8880566954 | 22B1
	         ----------+---------------+------- 

        1.相位数据为系统设定相位。作为相位校正系统，相位值应为被校正系统相位
		  的相反值。
        2.相位取值范围为 -PI ～+PI，乘以 10000 恰好在16位二进制范围内。
		3. (01P 命令的参考数据文件 P.dat

		(01LFFCC            8字节, 从FLASH第 FF 分区读入数据作为 CC 通道的相位。
		(01SFF              6字节, 把最后一次改变的相位参数存入FLASH FF 分区。

		FF 编号可以从 00 到 50，是指用于存放相位数据的分区编号，不是真正的
		FLASH 物理分区号。

	算法评估：

	    系统主频设置247.5MHz，采样率64453.125Hz，每两次采样间隔内时钟周期数
		    N= 247.5MHz/64453.125Hz = 3840
		滤波计算量：401阶，4通道，每个点处理 2 周期
		    401x2x4 = 3208
		基本满负荷运转。

	存在问题：
        低频误差较大。考虑分频段处理。用FIR切出低频，降采样率再行相位校正，
	最后内插恢复。	

2015-05-26
	version 0.3
	高频、低频分段处理
	高频通过181阶FIR高通滤波，低频通过8阶butterworth低通滤波，频率分界点约在
	2kHz。低频部分降采样率到1/16Fs。分别构造低频、高频的相位校正FIR滤波器，
	阶数分别是 241 和 61。低频部分再通过一个10阶butterworth低通滤波，内插上
	采样，与高频部分延迟迭加复原。相位计算时已考虑附加滤波器带来的相位改变。


          INPUT0 --+--> Phase_system0 ---> OUTPUT_A
                   |
                   +--> -----//----------> OUTPUT_C=0
	    		   |
                   +---------------------> OUTPUT_E

          INPUT1 --+--> Phase_system1 ---> OUTPUT_B
                   |
                   +--> -----//----------> OUTPUT_D=0
	    		   |
                   +---------------------> OUTPUT_F

	算法评估(单一通道)：

		高通分频滤波(FIR)             181 + R1 
		低通分频滤波(butterworth-8)   8*4 + R2
		高通相位滤波(FIR)             61  + R3
		    低通相位滤波(FIR)         241 + R4  (降采样后，每16点一次)
		差值升采样(butterworth-10)    10*4 +R5

		Rx 为零星指令。
		每通道大致指令数 600


